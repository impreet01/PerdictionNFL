name: Weekly NFL Predictions

on:
  schedule:
    - cron: '0 10 * 9-12,1 *'  # Run during NFL season
  workflow_dispatch:
    inputs:
      season:
        description: 'Season override (default: current year)'
        required: false
      week:
        description: 'Week override (default: auto)'
        required: false
      force_regenerate:
        description: 'Force regenerate predictions even if artifacts exist'
        required: false
        type: boolean
        default: false

env:
  ARTIFACTS_DIR: ${{ vars.ARTIFACTS_DIR || 'artifacts' }}
  NODE_VERSION: 20.x
  LOG_LEVEL: info
  CI_FAST: '1'

jobs:
  train-and-predict:
    runs-on: ubuntu-latest
    timeout-minutes: 160
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Run core tests
        run: npm run test:core
        continue-on-error: false

      - name: Resolve season and week
        id: resolve
        run: |
          # Resolve season
          if [ -n "${{ github.event.inputs.season }}" ]; then
            SEASON="${{ github.event.inputs.season }}"
          else
            SEASON=$(node -e 'console.log(new Date().getFullYear())')
          fi
          echo "SEASON=$SEASON" >> $GITHUB_ENV
          echo "season=$SEASON" >> $GITHUB_OUTPUT

          # Resolve week
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
          else
            WEEK=$(node scripts/resolveWeek.js | sed -n 's/Resolved WEEK=\(.*\)$/\1/p' || echo "2")
            if [ -z "$WEEK" ]; then WEEK=2; fi
          fi
          echo "WEEK=$WEEK" >> $GITHUB_ENV
          echo "week=$WEEK" >> $GITHUB_OUTPUT

          PAD_WEEK=$(printf '%02d' "$WEEK")
          echo "PAD_WEEK=$PAD_WEEK" >> $GITHUB_ENV
          echo "pad_week=$PAD_WEEK" >> $GITHUB_OUTPUT

          echo "Training for Season: $SEASON, Week: $WEEK"

      - name: Restore historical training cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ARTIFACTS_DIR }}/models
            ${{ env.ARTIFACTS_DIR }}/training_state.json
          key: historical-training-${{ hashFiles('trainer/trainingState.js', 'artifacts/training_state.json') }}
          restore-keys: |
            historical-training-

      - name: Bootstrap training state if needed
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          ROOT="${ARTIFACTS_DIR:-artifacts}"
          if [ ! -f "${ROOT}/training_state.json" ]; then
            echo "Creating training state..."
            npm run bootstrap:state || echo "Bootstrap failed, will use existing artifacts"
          fi

      - name: Run historical training on cache miss
        if: steps.cache.outputs.cache-hit != 'true'
        timeout-minutes: 45
        run: |
          echo "Cache miss detected - running historical training to populate cache"
          echo "This will train on all historical seasons (1999-2024) to build the training cache"
          echo "Using aggressive memory optimization: batch_size=1, max_workers=1, serial processing"
          echo "Respecting existing prediction artifacts to maintain integrity"
          # Unset SEASON and WEEK so train_multi.js doesn't enter weekly mode
          unset SEASON WEEK
          CI_FAST=1 BATCH_SIZE=1 MAX_WORKERS=1 DATA_FETCH_CONCURRENCY=1 npm run train:multi
        env:
          BATCH_SIZE: '1'
          MAX_WORKERS: '1'
          DATA_FETCH_CONCURRENCY: '1'
          NODE_OPTIONS: '--max-old-space-size=7168 --expose-gc'

      - name: Fetch context data
        run: |
          echo "Fetching injuries, markets, and weather data..."
          npm run fetch:injuries -- --season=${{ env.SEASON }} --week=${{ env.WEEK }} || echo "Warning: Failed to fetch injuries"
          npm run fetch:markets -- --season=${{ env.SEASON }} --week=${{ env.WEEK }} || echo "Warning: Failed to fetch markets"
          npm run fetch:weather -- --season=${{ env.SEASON }} --week=${{ env.WEEK }} || echo "Warning: Failed to fetch weather"
        continue-on-error: true
        env:
          ROTOWIRE_ENABLED: 'true'

      - name: Validate data freshness
        run: |
          echo "Validating fetched data for current week only..."
          node scripts/validateDataFreshness.js --season=${{ env.SEASON }} --week=${{ env.WEEK }}
        continue-on-error: true

      - name: Build game context
        run: npm run build:context
        env:
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ env.WEEK }}

      - name: Promote prior season model
        run: |
          node --input-type=module -e "
          const season = Number(process.env.SEASON);
          if (!Number.isFinite(season)) {
            console.log('No season resolved; skipping promotion.');
            process.exit(0);
          }
          const prev = season - 1;
          (async () => {
            const { promote } = await import('./trainer/promotePreviousSeason.js');
            const ok = await promote({ prevSeason: prev, nextSeason: season });
            if (!ok) {
              console.log('Unable to promote - this is OK for new seasons');
            } else {
              console.log(\`Promoted model from \${prev} â†’ \${season}\`);
            }
          })().catch((err) => {
            console.error('Promotion error (non-fatal):', err.message);
          });
          " || echo "Promotion skipped"
        continue-on-error: true

      - name: Train and generate predictions
        timeout-minutes: 45
        run: |
          echo "Training for Season $SEASON, Week $WEEK"
          # Use same aggressive memory settings as historical training
          CI_FAST=1 MAX_WORKERS=1 DATA_FETCH_CONCURRENCY=1 SEASON=${{ env.SEASON }} WEEK=${{ env.WEEK }} npm run train:multi
        env:
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ env.WEEK }}
          MAX_WORKERS: '1'
          DATA_FETCH_CONCURRENCY: '1'
          NODE_OPTIONS: '--max-old-space-size=7168 --expose-gc'
          REWRITE_HISTORICAL: ${{ github.event.inputs.force_regenerate || 'false' }}

      - name: Run hybrid calibration
        timeout-minutes: 25
        run: node trainer/hybrid_v2.js || echo "Calibration failed (non-fatal)"
        continue-on-error: true
        env:
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ env.WEEK }}
          NODE_OPTIONS: '--max-old-space-size=7168 --expose-gc'

      - name: Validate output artifacts
        run: npm run validate:artifacts || echo "Validation warnings found (non-fatal)"
        continue-on-error: true

      - name: Show generated artifacts
        run: |
          ROOT="${ARTIFACTS_DIR:-artifacts}"
          echo "=== Generated Artifacts ==="
          ls -lh "${ROOT}"/predictions_*.json "${ROOT}"/model_*.json 2>/dev/null || echo "No artifacts found"

          # Show season summaries if they exist
          for f in "${ROOT}"/season_*.json; do
            [ -f "$f" ] && echo "--- $(basename $f) ---" && head -20 "$f"
          done

      - name: Commit and push results
        id: commit
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          ROOT="${ARTIFACTS_DIR:-artifacts}"
          stamp="${{ env.SEASON }}_W${{ env.PAD_WEEK }}"

          # Add weekly artifacts
          git add -f \
            "${ROOT}/predictions_${stamp}.json" \
            "${ROOT}/model_${stamp}.json" \
            "${ROOT}/bt_features_${stamp}.json" \
            "${ROOT}/diagnostics_${stamp}.json" \
            "${ROOT}/context_${{ env.SEASON }}_W${{ env.PAD_WEEK }}.json" \
            "${ROOT}/training_state.json" \
            2>/dev/null || true

          # Add weekly data files (injuries, weather, markets) for current week only
          git add -f \
            "${ROOT}/injuries_${stamp}.json" \
            "${ROOT}/weather_${stamp}.json" \
            "${ROOT}/markets_${stamp}.json" \
            2>/dev/null || true

          # Add outcomes and metrics for all previous weeks of the season
          # These are generated by updateHistoricalArtifacts for weeks with complete scores
          git add -f "${ROOT}"/outcomes_${{ env.SEASON }}_W*.json 2>/dev/null || true
          git add -f "${ROOT}"/metrics_${{ env.SEASON }}_W*.json 2>/dev/null || true
          git add -f "${ROOT}"/metrics_${{ env.SEASON }}.json 2>/dev/null || true
          git add -f "${ROOT}"/season_index_${{ env.SEASON }}.json 2>/dev/null || true
          git add -f "${ROOT}"/season_summary_${{ env.SEASON }}.json 2>/dev/null || true

          # Add summary files
          git add -f "${ROOT}"/*_current.json 2>/dev/null || true
          git add -f "${ROOT}"/season_*.json 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "NFL predictions S=${{ env.SEASON }}, W=${{ env.WEEK }}"
          git pull --rebase --autostash || true
          git push || exit 1

      - name: Create PR if push failed
        if: steps.commit.outcome == 'failure'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "NFL predictions S=${{ env.SEASON }}, W=${{ env.WEEK }}"
          title: "Predictions: S=${{ env.SEASON }}, W=${{ env.WEEK }}"
          body: |
            Automated weekly predictions and model update.

            - Season: ${{ env.SEASON }}
            - Week: ${{ env.WEEK }}
          branch: "bot/predictions-S${{ env.SEASON }}-W${{ env.WEEK }}"
          labels: automated

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts-S${{ env.SEASON }}-W${{ env.WEEK }}
          path: |
            .test_artifacts/**
            trainer/tests/*.log
            **/*.log
          if-no-files-found: ignore
          retention-days: 3
