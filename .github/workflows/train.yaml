name: weekly model + predictions

on:
  schedule:
    - cron: '10 11 * 9-12 *'
    - cron: '10 11 * 1 *'
  workflow_dispatch:
    inputs:
      season:
        description: 'Season override (default: current year)'
        required: false
      week:
        description: 'Week override (default: auto via resolveWeek.js)'
        required: false

jobs:
  train:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 20.x

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Do NOT enable cache here (it forces a lockfile). Keep it simple/stable.
      - name: Use Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Create a lockfile if missing so installs are deterministic
      - name: Ensure lockfile
        run: |
          if [ ! -f package-lock.json ]; then
            echo "No package-lock.json found; generating oneâ€¦"
            npm install --package-lock-only
          else
            echo "Found existing package-lock.json"
          fi

      # Prefer deterministic install; fall back to npm install if needed
      - name: Install deps
        run: |
          npm ci || npm install --no-audit --no-fund

      - name: Resolve season (auto unless override)
        run: |
          if [ -n "${{ github.event.inputs.season }}" ]; then
            echo "SEASON=${{ github.event.inputs.season }}" >> $GITHUB_ENV
          else
            echo "SEASON=$(node -e 'console.log(new Date().getFullYear())')" >> $GITHUB_ENV
          fi
          echo "Resolved SEASON=$SEASON"

      - name: Resolve week (auto unless override)
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            echo "WEEK=${{ github.event.inputs.week }}" >> $GITHUB_ENV
            echo "Resolved WEEK=$WEEK (manual override)"
          else
            WEEK=$(node scripts/resolveWeek.js | sed -n 's/Resolved WEEK=\(.*\)$/\1/p')
            if [ -z "$WEEK" ]; then WEEK=2; fi
            echo "WEEK=$WEEK" >> $GITHUB_ENV
            echo "Resolved WEEK=$WEEK (auto)"
          fi

      - name: Train + Predict (auto week)
        run: |
          echo "Training SEASON=$SEASON WEEK=$WEEK"
          SEASON=$SEASON WEEK=$WEEK npm run train:multi

      - name: Show artifacts
        run: |
          echo "Artifacts directory:"
          ls -lah artifacts || true
          for f in artifacts/season_index_*.json artifacts/season_summary_*.json; do
            [ -f "$f" ] && echo "--- $f ---" && cat "$f"
          done

      - name: Commit artifacts (skip if no changes)
        run: |
          git config user.name "gh-actions"
          git config user.email "actions@users.noreply.github.com"
          git add artifacts/*.json || true
          if git diff --cached --quiet; then
            echo "No artifact changes to commit."
          else
            git commit -m "weekly model + predictions (S=$SEASON, W=$WEEK)"
            git push
          fi
