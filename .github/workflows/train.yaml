name: weekly model + predictions

on:
  schedule:
    - cron: '0 10 * 9-12,1 *'
  workflow_dispatch:
    inputs:
      season:
        description: 'Season override (default: current year)'
        required: false
      week:
        description: 'Week override (default: auto via resolveWeek.js)'
        required: false

env:
  NODE_VERSION: 20.x
  LOG_LEVEL: warn
  CI_FAST: '1'
  MAX_WORKERS: '2'

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 75
    strategy:
      max-parallel: 1
      matrix:
        chunk:
          - label: '1999-2000'
            start: 1999
            end: 2000
            artifact_in: ''
            artifact_out: 'bootstrap-1999-2000'
          - label: '2001-2002'
            start: 2001
            end: 2002
            artifact_in: 'bootstrap-1999-2000'
            artifact_out: 'bootstrap-2001-2002'
          - label: '2003-2004'
            start: 2003
            end: 2004
            artifact_in: 'bootstrap-2001-2002'
            artifact_out: 'bootstrap-2003-2004'
          - label: '2005-2006'
            start: 2005
            end: 2006
            artifact_in: 'bootstrap-2003-2004'
            artifact_out: 'bootstrap-2005-2006'
          - label: '2007-2008'
            start: 2007
            end: 2008
            artifact_in: 'bootstrap-2005-2006'
            artifact_out: 'bootstrap-2007-2008'
          - label: '2009-2010'
            start: 2009
            end: 2010
            artifact_in: 'bootstrap-2007-2008'
            artifact_out: 'bootstrap-2009-2010'
          - label: '2011-2012'
            start: 2011
            end: 2012
            artifact_in: 'bootstrap-2009-2010'
            artifact_out: 'bootstrap-2011-2012'
          - label: '2013-2014'
            start: 2013
            end: 2014
            artifact_in: 'bootstrap-2011-2012'
            artifact_out: 'bootstrap-2013-2014'
          - label: '2015-2016'
            start: 2015
            end: 2016
            artifact_in: 'bootstrap-2013-2014'
            artifact_out: 'bootstrap-2015-2016'
          - label: '2017-2018'
            start: 2017
            end: 2018
            artifact_in: 'bootstrap-2015-2016'
            artifact_out: 'bootstrap-2017-2018'
          - label: '2019-2020'
            start: 2019
            end: 2020
            artifact_in: 'bootstrap-2017-2018'
            artifact_out: 'bootstrap-2019-2020'
          - label: '2021-2022'
            start: 2021
            end: 2022
            artifact_in: 'bootstrap-2019-2020'
            artifact_out: 'bootstrap-2021-2022'
          - label: '2023-2024'
            start: 2023
            end: 2024
            artifact_in: 'bootstrap-2021-2022'
            artifact_out: 'bootstrap-final'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Use Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Prepare artifacts directory
        run: |
          rm -rf artifacts
          mkdir -p artifacts
      - name: Restore previous artifacts
        if: ${{ matrix.chunk.artifact_in != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.chunk.artifact_in }}
          path: artifacts
      - name: Ensure lockfile
        run: |
          if [ ! -f package-lock.json ]; then
            echo "No package-lock.json found; generating one…"
            npm install --package-lock-only
          else
            echo "Found existing package-lock.json"
          fi
      - name: Install deps
        run: npm ci || npm install --no-audit --no-fund
      - name: Bootstrap training state (if missing)
        run: |
          if [ ! -f artifacts/training_state.json ]; then
            BATCH_START=${{ matrix.chunk.start }} \
            BATCH_END=${{ matrix.chunk.end }} \
            npm run bootstrap:state
          fi
      - name: Run chunked historical training ${{ matrix.chunk.label }}
        env:
          BATCH_START: ${{ matrix.chunk.start }}
          BATCH_END: ${{ matrix.chunk.end }}
          CI_FAST: '1'
        run: |
          echo "Running historical chunk ${{ matrix.chunk.label }}"
          if [ -f "artifacts/chunks/model_${{ matrix.chunk.label }}.done" ]; then
            echo "Chunk ${{ matrix.chunk.label }} already complete – skipping."
            exit 0
          fi
          BATCH_START=${{ matrix.chunk.start }} \
          BATCH_END=${{ matrix.chunk.end }} \
          CI_FAST=1 npm run train:multi
      - name: Pack bootstrap chunk ${{ matrix.chunk.label }}
        run: |
          tar -czf bootstrap_chunk.tgz -C artifacts .
          mv bootstrap_chunk.tgz artifacts/bootstrap-${{ matrix.chunk.label }}.tgz
      - name: Upload artifacts ${{ matrix.chunk.label }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.chunk.artifact_out }}
          path: artifacts
          if-no-files-found: warn
          retention-days: 7

  train:
    runs-on: ubuntu-latest
    needs: bootstrap
    timeout-minutes: 90
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Use Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Prepare artifacts directory
        run: |
          rm -rf artifacts
          mkdir -p artifacts
      - name: Restore bootstrap artifacts
        uses: actions/download-artifact@v4
        with:
          name: bootstrap-final
          path: artifacts
      - name: Extract bootstrap cache
        run: |
          if ls artifacts/bootstrap-*.tgz >/dev/null 2>&1; then
            for archive in artifacts/bootstrap-*.tgz; do
              echo "Extracting ${archive}"
              tar -xzf "${archive}" -C artifacts
            done
          fi
      - name: Verify bootstrap cache presence
        run: |
          if [ ! -d artifacts/chunks ] || ! ls artifacts/chunks/model_*.done >/dev/null 2>&1; then
            echo "::error::Missing historical bootstrap cache markers."
            exit 1
          fi
      - name: Ensure lockfile
        run: |
          if [ ! -f package-lock.json ]; then
            echo "No package-lock.json found; generating one…"
            npm install --package-lock-only
          else
            echo "Found existing package-lock.json"
          fi
      - name: Install deps
        run: npm ci || npm install --no-audit --no-fund
      - name: Verify cached training state
        run: |
          if [ ! -f artifacts/training_state.json ]; then
            echo "::error::artifacts/training_state.json is missing. Restore the cached bootstrap artifacts before running the trainer to avoid replaying historical seasons."
            exit 1
          fi
      - name: Guard against historical override flags
        run: |
          flags=(
            REWRITE_HISTORICAL
            OVERWRITE_HISTORICAL
            REBUILD_HISTORICAL
            REGENERATE_HISTORICAL
            REGEN_HISTORICAL
            FORCE_HISTORICAL_BOOTSTRAP
          )
          tripped=()
          for flag in "${flags[@]}"; do
            value="${!flag}"
            if [ -n "${value}" ]; then
              tripped+=("${flag}")
            fi
          done
          if [ "${#tripped[@]}" -gt 0 ]; then
            echo "::error::Historical override flags detected: ${tripped[*]}. Unset them for routine runs so cached bootstraps remain valid."
            exit 1
          fi
      - name: Resolve season (auto unless override)
        run: |
          if [ -n "${{ github.event.inputs.season }}" ]; then
            echo "SEASON=${{ github.event.inputs.season }}" >> $GITHUB_ENV
          else
            echo "SEASON=$(node -e 'console.log(new Date().getFullYear())')" >> $GITHUB_ENV
          fi
          echo "Resolved SEASON=$SEASON"
      - name: Resolve week (auto unless override)
        id: resolve
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            echo "WEEK=${{ github.event.inputs.week }}" >> $GITHUB_ENV
            echo "Resolved WEEK=$WEEK (manual override)"
          else
            WEEK=$(node scripts/resolveWeek.js | sed -n 's/Resolved WEEK=\(.*\)$/\1/p')
            if [ -z "$WEEK" ]; then WEEK=2; fi
            echo "WEEK=$WEEK" >> $GITHUB_ENV
            echo "Resolved WEEK=$WEEK (auto)"
          fi
          echo "WEEK=$WEEK" >> $GITHUB_OUTPUT
      - name: Run unit tests
        run: npm test
      - name: Fetch Rotowire injuries
        env:
          ROTOWIRE_ENABLED: 'true'
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ steps.resolve.outputs.WEEK }}
        run: npm run fetch:injuries -- --season=$SEASON --week=$WEEK
      - name: Fetch Rotowire markets
        env:
          ROTOWIRE_ENABLED: 'true'
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ steps.resolve.outputs.WEEK }}
        run: npm run fetch:markets -- --season=$SEASON --week=$WEEK
      - name: Fetch Rotowire weather
        env:
          ROTOWIRE_ENABLED: 'true'
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ steps.resolve.outputs.WEEK }}
        run: npm run fetch:weather -- --season=$SEASON --week=$WEEK
      - name: Build context
        env:
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ steps.resolve.outputs.WEEK }}
          SINCE_SEASON: ${{ env.MIN_TRAIN_SEASON }}
        run: npm run build:context
      - name: Promote prior season ensemble
        env:
          SEASON: ${{ env.SEASON }}
        run: |
          node --input-type=module -e "const season = Number(process.env.SEASON); if (!Number.isFinite(season)) { console.log('No season resolved; skipping promotion.'); process.exit(0); } const prev = season - 1; (async () => { const { promote } = await import('./trainer/promotePreviousSeason.js'); const ok = await promote({ prevSeason: prev, nextSeason: season }); if (!ok) { console.error('Unable to promote final ensemble from prior season.'); process.exit(1); } console.log(`Promoted finals from ${prev} → ${season}`); })().catch((err) => { console.error(err); process.exit(1); });"
      - name: Train + Predict (auto week)
        timeout-minutes: 25
        run: |
          echo "Training SEASON=$SEASON WEEK=$WEEK"
          CI_FAST=1 SEASON=$SEASON WEEK=$WEEK npm run train:multi
      - name: Run Hybrid v2 Calibration
        timeout-minutes: 15
        run: node trainer/hybrid_v2.js
        env:
          SEASON: ${{ env.SEASON }}
          WEEK: ${{ steps.resolve.outputs.WEEK }}
      - name: Validate artifacts against schemas
        run: |
          echo "Validating artifacts in artifacts/"
          npm run validate:artifacts
      - name: Show artifacts
        run: |
          echo "Artifacts directory:"
          ls -lah artifacts || true
          for f in artifacts/season_index_*.json artifacts/season_summary_*.json; do
            [ -f "$f" ] && echo "--- $f ---" && cat "$f"
          done
      - name: Commit artifacts (try main)
        id: commit_main
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          pad_week=$(printf '%02d' "$WEEK")
          stamp="${SEASON}_W${pad_week}"
          targets=(
            "artifacts/predictions_${stamp}.json"
            "artifacts/model_${stamp}.json"
            "artifacts/bt_features_${stamp}.json"
            "artifacts/diagnostics_${stamp}.json"
            "artifacts/context_${SEASON}_W${pad_week}.json"
          )
          for file in "${targets[@]}"; do
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done
          find artifacts -maxdepth 1 -name '*_current.json' -print0 2>/dev/null | xargs -0 -r git add
          find artifacts/models/common -maxdepth 1 -name 'feature_stats_1999_*' -print0 2>/dev/null | xargs -0 -r git add
          if [ -d "artifacts/models/${SEASON}/week-00" ]; then
            find "artifacts/models/${SEASON}/week-00" -maxdepth 2 -type f -name '*.json' -print0 2>/dev/null | xargs -0 -r git add
          fi
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "No artifact changes to commit."
            exit 0
          fi
          git status --short || true
          git commit -m "weekly model + predictions (S=$SEASON, W=$WEEK)"
          git pull --rebase --autostash || true
          git push
          echo "no_changes=false" >> $GITHUB_OUTPUT
      - name: Create PR (fallback if push failed or branch protected)
        if: steps.commit_main.outcome == 'failure'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "weekly model + predictions (S=${{ env.SEASON }}, W=${{ env.WEEK }})"
          title: "Artifacts: S=${{ env.SEASON }}, W=${{ env.WEEK }}"
          body: "Automated artifacts update. Merge to publish."
          branch: "bot/artifacts-S${{ env.SEASON }}-W${{ env.WEEK }}"
          add-paths: |
            artifacts/*.json
